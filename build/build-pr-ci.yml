variables:
  buildConfiguration: Release

pr:
  branches:
    include:
    - main
  paths:
    exclude:
      - '**.md'

# Batch builds
trigger:
  branches:
    include:
      - main
  paths:
    exclude:
      - '**.md'

continueOnError: false
pool:
  image: "ubuntu-latest"

steps:
  - task: UseDotNet@2
    displayName: 'Install .NET 6'
    inputs:
      version: 6.0.x
      packageType: sdk

  - task: UseDotNet@2
    displayName: 'Install .NET 2.1'
    inputs:
      packageType: 'sdk'
      version: '2.1.x'
      performMultiLevelLookup: true

  - task: DotNetCoreCLI@2
    displayName: 'Dotnet Restore'
    inputs:
      command: 'restore'
      feedsToUse: 'config'
      nugetConfigPath: 'nuget.config'

  - task: DotNetCoreCLI@2
    displayName: Build project
    inputs:
      command: 'build'
      arguments: '--configuration $(buildConfiguration) --no-restore -p:ContinuousIntegrationBuild=true'
      projects: '**.csproj'

  - script: docker build -f samples/chat/csharp-inproc/Dockerfile -t openai-func-sample-csharp-inproc .
    displayName: Docker Build - Chat Bot Sample
      
  - script: docker run -d -p 10000:10000 -p 10001:10001 -p 10002:10002 mcr.microsoft.com/azure-storage/azurite
    displayName: Docker Run - Azurite

  - script: |
      docker run -d -p 7071:80 --name openai-func-sample-csharp-inproc \
            --add-host host.docker.internal:host-gateway \
            --env AZURE_OPENAI_KEY=$AZURE_OPENAI_KEY \
            --env AZURE_OPENAI_ENDPOINT=$AZURE_OPENAI_ENDPOINT \
            --env AZURE_DEPLOYMENT_NAME=$AZURE_DEPLOYMENT_NAME \
            --env 'AzureWebJobsStorage=UseDevelopmentStorage=true;DevelopmentStorageProxyUri=http://host.docker.internal' \
            openai-func-sample-csharp-inproc
    displayName: Docker Run - Chat Bot Sample

  - script: sleep 10s
    displayName: Sleep for 10 seconds

  - script: dotnet test --configuration $config --no-build --verbosity normal
    displayName: E2E Test - Chat Bot Sample

  - script: docker logs openai-func-sample-csharp-inproc
    displayName: Print Docker Logs - Chat Bot Sample
    condition: always()